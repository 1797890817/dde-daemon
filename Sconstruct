import os
import subprocess
import glob
import shutil
from SCons.Script.SConscript import SConsEnvironment
import SCons.Util

GOROOT='/usr/lib/go'
GOPATH=os.getcwd()

os.environ['GOROOT']=GOROOT
os.environ['GOPATH']=GOPATH

bin_components = os.listdir('bin')
components = ['accounts',
              'audio',
	      'screensaver',
              'bluetooth',
              'clipboard',
              'datetime',
              'display' ,
              'dock' ,
              'grub2',
              'inputdevices',
              'keybinding',
              'launcher',
              'mime',
              'mounts',
              'network',
              'Planner',
              'power',
              'screen_edges',
              'systeminfo',
              'themes',
              'dsc',
              'mpris'
              ]

SConsignFile()
opts=Variables()
opts.AddVariables(
    PathVariable('PREFIX', 'install-path base', '/usr'),
    BoolVariable('enable_i18n', 'enable i18n support', 'False'),
    PathVariable('DESTDIR', 'install to $DESTDIR/$PREFIX', '/')
)

ipackage_instdir = os.path.join('$DESTDIR', '$PREFIX')
ipackage_instdir_go = os.path.join(ipackage_instdir, 'lib/deepin-daemon')
ipackage_instdir_locale = os.path.join(ipackage_instdir, 'share/locale/')

env = Environment( tools = ['default', 'textfile'], options = opts, ENV = os.environ)

opts.Update(env)

Export('env')
if env['enable_i18n']:
    languages = SConscript('data/po/SConscript')
else :
    languages = None

#prepare source dir
if os.path.exists(os.path.join(GOPATH, 'src')):
    shutil.rmtree(os.path.join(GOPATH,'src'))
os.makedirs(os.path.join(GOPATH,'src','dde-daemon'))

for src in glob.glob(os.path.join(os.getcwd(), "*.go")):
    name = os.path.basename(src)
    os.symlink(src, os.path.join(GOPATH, 'src', 'dde-daemon', name))

for component in components:
    os.symlink(os.path.join(os.getcwd(),component), os.path.join(GOPATH, 'src', 'dde-daemon', component))

owd = os.getcwd()
for component in bin_components:
    try:
        os.chdir('bin/%s' % component)
        print "Go build %s" % component
        p = subprocess.Popen('go build', shell=True).wait()
        if p != 0:
            exit(1)
    except:
        print "Error while building %s" % component
        exit(1)
    finally:
        os.chdir(owd)


for component in bin_components:
    print "install %s " % component
    env.Install(ipackage_instdir_go, 'bin/%s/%s' % (component,component))

if languages:
    for language in languages:
        env.Install(ipackage_instdir_locale, 'data/po/%s' % language)

ipackage_instdir_conf = os.path.join('$DESTDIR', 'etc/dbus-1/systemd.d')
for f in glob.glob(os.path.join(os.getcwd(),'data/conf','*.conf')):
    env.Install(ipackage_instdir_conf, f)

ipackage_instdir_service = os.path.join('$DESTDIR', 'usr/share/dbus-1/services/')
for f in glob.glob(os.path.join(os.getcwd(),'data/services','*.service')):
    env.Install(ipackage_instdir_service, f)

ipackage_instdir_system_service = os.path.join('$DESTDIR', 'usr/share/dbus-1/system-services/')
for f in glob.glob(os.path.join(os.getcwd(),'data/system-services','*.service')):
    env.Install(ipackage_instdir_system_service, f)

ipackage_instdir_polkit_action = os.path.join('$DESTDIR', 'usr/share/polikit-1/actions/')
for f in glob.glob(os.path.join(os.getcwd(),'data/polikit-action','*.policy')):
    env.Install(ipackage_instdir_polkit_action, f)

ipackage_instdir_schemas = os.path.join('$DESTDIR', 'usr/share/glib-2.0/schemas')
for f in glob.glob(os.path.join(os.getcwd(),'data/schemas/','*.xml')):
    env.Install(ipackage_instdir_polkit_action, f)

if os.path.exists(os.path.join(os.getcwd(),'data/lang')):
    env.Install(os.path.join(ipackage_instdir,'share/dde-daemon'), os.path.join(os.getcwd(),'data/lang'))
if os.path.exists(os.path.join(os.getcwd(),'data/template')):
    env.Install(os.path.join(ipackage_instdir,'share/dde-daemon'), os.path.join(os.getcwd(),'data/template'))

for f in glob.glob(os.path.join(os.getcwd(),'data/tool/', 'wireless_script*')):
    target = os.path.join(ipackage_instdir,'bin/wireless-script')
    env.InstallAs(target, f)
    #TODO:need fix prem
    break

env.Alias('install', ipackage_instdir)

Help(opts.GenerateHelpText(env))
